# Performance on MUSA S4000

# 性能测试
测试了Opensora 16x256x256 多卡间性能和最终loss
## 总览
| Plugin             | 分布式信息       | 吞吐量(图/秒/GPU)  | 吞吐量(token/秒/GPU) | Final loss          |
|-------------------|--------------|----------------------- |---------------------|---------------------|
| ddp               | 1卡          | 0.603                  | 259.755             |nan                  |
| ddp               | 2卡          | 0.731                  | 202.794             |0.4020410478115082   |
| ddp               | 4卡          | 1.445                  | 184.947             |0.25558748841285706  |
| ddp               | 8卡          | 1.635                  | 151.353             |0.010965066030621    |
| zero2             | 1卡          | 0.645                  | 330.487             |0.000104736167192    |
| zero2             | 2卡          | 0.833                  | 213.206             |0.002376629039645    |
| zero2             | 4卡          | 1.717                  | 219.723             |0.002376629039645    |
| zero2             | 8卡          | 2.025                  | 129.630             |0.010965066030621    |
| zero2-seq         | 1卡          | 0.637                  | 326.324             |0.00911              |
| zero2-seq         | 2卡          | 0.778                  | 199.139             |0.002376629039645    |
| zero2-seq         | 4卡          | 1.284                  | 164.315             |0.003242161124944687 | 
| zero2-seq         | 8卡          | 1.891                  | 121.025             |0.006349639035761356 |

## 具体表现

### 算力使用明细
| Plugin             | 分布式信息      | 批次大小    | 序列长度     |  TFLOPS每GPU    |TFLOPS每GPU(Megatron) | 延迟(s)     |
|------------------- |--------------- |------------|------------- |----------------|---------------------|-----------|
| zero2              | 1卡            | 1          | 512          | 0.029          | 0.011               | 1.549      |
| zero2              | 2卡            | 1          | 512          | 0.019          | 0.007               | 2.401      |
| zero2              | 4卡            | 1          | 512          | 0.020          | 0.007               | 2.330      |
| zero2              | 8卡            | 1          | 512          | 0.012          | 0.004               | 3.950      |

### 时间使用明细
| Plugin             | 分布式信息      | 平均数据传输延迟(ms)  | 平均视频编码延迟(ms)  | 平均文本编码延迟(ms)  | 平均前向传播延迟(ms) | 平均反向传播延迟(ms)  | 平均优化器更新延迟(ms) | 平均单步延迟延迟(ms)   |
|------------------- |--------------- |---------------------|---------------------|---------------------|---------------------|---------------------|-----------------------|-----------------------|
| ddp                | 1卡            | 375.04              | 359.75              | 306.21              | 243.05              | 805.10              | 363.60               | 1423.19               |
| ddp                | 2卡            | 112.43              | 258.41              | 298.34              | 354.32              | 1382.57             | 1322.28              | 2406.08               |
| ddp                | 4卡            | 232.63              | 264.79              | 309.60              | 356.35              | 1604.99             | 1507.83              | 2768.36               |
| ddp                | 8卡            | 511.61              | 295.68              | 327.35              | 358.81              | 1889.37             | 2077.77              | 3382.83               |
| zero2              | 1卡            | 65.01               | 258.62              | 307.45              | 354.31              | 1193.25             | 1010.39              | 2178.63               |
| zero2              | 2卡            | 101.51              | 257.66              | 304.91              | 349.73              | 1523.61             | 1272.69              | 2537.42               |
| zero2              | 4卡            | 565.40              | 248.97              | 248.97              | 248.97              | 1515.84             | 1007.59              | 2330.21               |
| zero2              | 8卡            | 919.17              | 362.73              | 362.73              | 362.73              | 2667.82             | 2162.11              | 3949.72               |
| zero2-seq          | 1卡            | 392.09              | 249.21              | 249.21              | 249.25              | 927.65              | 704.81               | 1568.99               |
| zero2-seq          | 2卡            | 675.50              | 354.90              | 354.97              | 354.90              | 1540.67             | 1324.59              | 2571.07               |
| zero2-seq          | 4卡            | 227.89              | 261.65              | 316.00              | 356.34              | 1954.09             | 1528.21              | 3115.96               |
| zero2-seq          | 8卡            | 458.78              | 272.44              | 338.52              | 364.29              | 2796.50             | 2301.49              | 4230.52               |

### 内存使用明细
| Plugin             | 分布式信息      | 权重(GB)               | 梯度(GB)              | 优化器(GB)            | 激活值(GB)             | 峰值(GB)                | 碎片(GB)                | 最终GPU存储空间占用(GB) | 最终CPU存储空间占用(GB) |
|------------------- |--------------- |---------------------|---------------------|---------------------|---------------------|-----------------------|-----------------------|-----------------------|-----------------------|
| ddp                | 1卡            | 0.707              | 0.707              | 16.882              | 1.094               | 19.391               | 4.734               | 17.590               |9.939               |
| ddp                | 2卡            | 0.707              | 0.707              | 16.882               | 2.148               | 20.445                 | 6.559               | 17.590               | 9.935               |
| ddp                | 4卡            | 0.707              | 0.707              | 16.878               | 2.152               | 20.444                 | 6.560               | 17.585               | 9.941               |
| ddp                | 8卡            | 0.707              | 0.707              | 16.878               | 2.152               | 20.444                 | 6.560               | 17.585               | 9.939               |
| zero2              | 1卡            | 0.707              | 0.707              | 21.182              | 3.572               | 26.169               | 1.378               | 21.889               |9.905               |
| zero2              | 2卡            | 0.707              | 0.707              | 16.891               | 1.437               | 19.742                 | 3.613               | 17.598               | 9.941               |
| zero2              | 4卡            | 0.707              | 0.707              | 14.737               | 1.835               | 17.987                 | 2.001               | 15.445               | 9.910               |
| zero2              | 8卡            | 0.707              | 0.707              | 13.687               | 2.885               | 17.987                 | 4.962               | 14.395               | 9.936               |
| zero2-seq           | 1卡            | 0.707              | 0.707              | 21.152              | 3.570               | 26.137               | 2.373               | 21.859               |9.939               |
| zero2-seq          | 2卡            | 0.707              | 0.707              | 16.891               | 1.798               | 20.104                 | 2.130               | 17.599               | 9.937               |
| zero2-seq          | 4卡            | 0.707              | 0.707              | 14.755               | 1.817               | 17.987                 | 7.786               | 15.463               | 9.936               |
| zero2-seq          | 8卡            | 0.707              | 0.707              | 13.687               | 2.885               | 17.987                 | 7.843               | 14.395               | 9.937               |

